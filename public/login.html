<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Iniciar sesi√≥n - Mawi</title>    <meta name="description" content="Iniciar sesi√≥n en Mawi" />    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="mawi-auth-container">
      <div class="mawi-auth-card">
        <h1>Iniciar sesi√≥n</h1>
        <p class="link-text">
          <a href="signup.html" class="mawi-link">¬øCrear cuenta?</a>
        </p>        <form id="loginForm">
          <div class="form-group">
            <label for="email">Correo electr√≥nico</label>
            <input
              id="email"
              type="email"
              placeholder="Escribe tu correo"
              required
            />
          </div>

          <div class="form-group">
            <label for="password">Contrase√±a</label>
            <input
              id="password"
              type="password"
              placeholder="Escribe tu contrase√±a"
              required
            />
            <div class="forgot-password">
              <a href="recover-password.html" class="mawi-link">¬øHas olvidado tu contrase√±a?</a>
            </div>
          </div>

          <button type="submit" class="mawi-button" id="loginBtn">
            Iniciar sesi√≥n
          </button>
        </form>        <div class="help-text">
          <p>
            ¬øNecesitas ayuda? <a href="#" class="mawi-link">Contacta con nosotros</a>
          </p>
        </div>
        
        <div class="nav-link">
          <a href="index.html" class="mawi-link">Volver al inicio</a>
        </div>
      </div>    </div>    <script>
      document.addEventListener('DOMContentLoaded', function() {
        console.log('üéØ DOM cargado, inicializando login...');
        
        const loginForm = document.getElementById('loginForm');
        if (!loginForm) {
          console.error('‚ùå No se encontr√≥ el formulario de login');
          return;
        }
        
        loginForm.addEventListener('submit', async function(event) {
          event.preventDefault();
          event.stopPropagation();
          
          console.log('üîÑ Iniciando proceso de login...');

          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;
          const loginBtn = document.getElementById('loginBtn');

          console.log('üìß Email:', email);
          console.log('üîë Password length:', password.length);

          // Validaci√≥n b√°sica
          if (!email || !password) {
            alert('Por favor completa todos los campos');
            return;
          }

          // Mostrar loading b√°sico
          loginBtn.disabled = true;
          loginBtn.textContent = 'Iniciando sesi√≥n...';

          try {
            console.log('üì° Enviando petici√≥n a /Consultas/api/login');
            
            const response = await fetch('/Consultas/api/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, password })
            });

            console.log('üìä Response status:', response.status);
            console.log('üìä Response ok:', response.ok);

            const data = await response.json();
            console.log('üìÑ Response data:', data);
            
            if (response.ok && data.token) {
              console.log('‚úÖ Login exitoso, procesando token...');
              
              try {
                const payload = JSON.parse(atob(data.token.split('.')[1]));
                console.log('üîç Token payload:', payload);
                
                const rol = data.rol || payload.rol;
                const estado = data.estado || payload.estado;
                const nombre = data.nombre || payload.nombre || payload.name;
                
                console.log('üë§ Usuario:', { rol, estado, nombre });

                // Verificar si el usuario est√° activo
                if (estado !== 'A' && estado !== 'active') {
                  alert('Usuario inactivo. Espera la activaci√≥n de tu cuenta por correo electr√≥nico.');
                  return;
                }

                // Guardar token y datos del usuario
                localStorage.setItem('token', data.token);
                localStorage.setItem('userData', JSON.stringify({
                  name: nombre,
                  email: email,
                  role: rol,
                  status: estado
                }));
                
                console.log('üéØ Redirigiendo seg√∫n rol:', rol);

                // Redirecci√≥n directa sin delays
                switch (parseInt(rol)) {
                  case 1: // Usuario b√°sico
                    console.log('‚û°Ô∏è Redirigiendo a dashboard.html');
                    window.location.href = 'dashboard.html';
                    break;
                    
                  case 2: // L√≠der/Biomonitor
                    console.log('‚û°Ô∏è Redirigiendo a dashboard.html');
                    window.location.href = 'dashboard.html';
                    break;
                    
                  case 3: // Administrador
                    console.log('‚û°Ô∏è Redirigiendo a indexAdmin.html');
                    window.location.href = 'indexAdmin.html';
                    break;
                    
                  case 4: // Super Administrador
                    console.log('‚û°Ô∏è Redirigiendo a indexSAdmin.html');
                    window.location.href = 'indexSAdmin.html';
                    break;
                    
                  default:
                    console.log('‚û°Ô∏è Rol no reconocido, redirigiendo a dashboard.html');
                    window.location.href = 'dashboard.html';
                }
                
              } catch (tokenError) {
                console.error('‚ùå Error procesando token:', tokenError);
                alert('Error procesando datos de usuario');
              }
              
            } else {
              console.log('‚ùå Login fallido');
              
              // Mostrar mensaje de error m√°s espec√≠fico
              const errorMessage = data.message || data.error || 'Credenciales incorrectas';
              alert(`Error de autenticaci√≥n: ${errorMessage}`);
            }
            
          } catch (error) {
            console.error('‚ùå Error en login:', error);
            
            // Verificar si es un error de conexi√≥n
            if (error.name === 'TypeError' && error.message.includes('fetch')) {
              alert('Error de conexi√≥n. Verifica que el servidor est√© funcionando.');
            } else {
              alert(`Error inesperado: ${error.message}`);
            }
          } finally {
            // Rehabilitar bot√≥n
            loginBtn.disabled = false;
            loginBtn.textContent = 'Iniciar sesi√≥n';
            console.log('üîÑ Proceso de login finalizado');
          }
        });      });
    </script>
    
    <!-- Keep the GPT Engineer script tag -->
    <script src="https://cdn.gpteng.co/gptengineer.js" type="module"></script>
  </body>
</html>